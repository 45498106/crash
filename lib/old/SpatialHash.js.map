{"version":3,"sources":["../../src/old/SpatialHash.js"],"names":["define","require","exports","module","Signal","_TICK","SpatialHash","width","height","size","hash","buildHash","cache","prototype","i","add","obj","shift","hitArea","body","shape","sx","position","x","sy","y","ex","ey","id","push","retrieve","ret","addSquare","removeDuplicates","array","concat","tempArray","retrieveArea","length","tick","index","cell","item","seen","out","len","j","UID","remove","indexOf","splice","empty"],"mappings":"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","file":"SpatialHash.js","sourcesContent":["define(function (require, exports, module)\n{\n    var Signal = require('signals');\n    var _TICK = 0;\n    /**\n     * Game obj\n     * @param {PIXI obj} view\n     */\n    var SpatialHash = function(width, height, size)\n    {\n        this.hash = [];\n         // this.hash = {};\n\n        this.width = 300;\n        this.height = 300;\n\n        this.size = 64 + 32;\n\n        this.buildHash();\n        this.cache = {};\n\n\n\n    }\n\n    SpatialHash.prototype.buildHash = function()\n    {\n        var width = this.width;\n        var height = this.height;\n\n        var size = width * height;\n\n        for (var i = 0; i < size; i++)\n        {\n            this.hash[i] = [];\n        };\n\n        this.cache = {};\n    }\n\n    SpatialHash.prototype.add = function(obj)\n    {\n        this.cache = {};\n\n        var shift = 5; // power of two!\n        var hitArea = obj.body.shape;\n        var sx = ((obj.position.x + hitArea.x) / this.size) | 0,\n            sy = ((obj.position.y + hitArea.y) / this.size) | 0,\n            ex = ((obj.position.x +  hitArea.x + hitArea.width )/ this.size) | 0,\n            ey = ((obj.position.y +  hitArea.y + hitArea.height)/ this.size) | 0,\n            x, y;\n\n\n        for(y=sy;y<=ey;y++)\n        {\n            for(x=sx;x<=ex;x++)\n            {\n                //TODO take out the floor!\n                var id = y * this.width + x;\n\n                if(! this.hash[id] )\n                {\n\n                }\n                else\n                {\n                    this.hash[id].push( obj );\n                }\n            }\n        }\n\n    }\n\n    SpatialHash.prototype.retrieve = function(obj)\n    {\n        // current square is..\n        var x = (obj.position.x / this.size) | 0,\n            y = (obj.position.y / this.size) | 0;\n\n        var ret = this.cache[x + \":\" + y];\n\n        if(!ret)\n        {\n            ret = [];\n\n            // get the 9 squares..\n            ret = this.addSquare(x-1, y-1, ret)\n            ret = this.addSquare(x, y-1, ret)\n            ret = this.addSquare(x+1, y-1, ret)\n            ret = this.addSquare(x-1, y, ret)\n            ret = this.addSquare(x, y, ret)\n            ret = this.addSquare(x+1, y, ret)\n            ret = this.addSquare(x, y+1, ret)\n            ret = this.addSquare(x, y+1, ret)\n            ret = this.addSquare(x+1, y+1, ret);\n\n            ret = this.removeDuplicates(ret);\n\n            this.cache[x + \":\" + y] = ret;\n\n            //console.log(\"CACHE\")\n        }\n\n        return ret;\n    }\n\n    SpatialHash.prototype.addSquare = function(x, y, array)\n    {\n        var id = y * this.width + x;\n        if(!this.hash[id])\n        {\n\n        }\n        else\n        {\n            array = array.concat( this.hash[id] );\n        }\n\n        return array;\n    }\n\n    var tempArray = [];\n\n    SpatialHash.prototype.retrieveArea = function(obj)\n    {\n        var shift = 5; // power of two!\n        var hitArea = obj.body.shape;\n        var sx = ((obj.position.x + hitArea.x) / this.size) | 0,\n            sy = ((obj.position.y + hitArea.y) / this.size) | 0,\n            ex = ((obj.position.x +  hitArea.x + hitArea.width )/ this.size) | 0,\n            ey = ((obj.position.y +  hitArea.y + hitArea.height)/ this.size) | 0,\n            x, y;\n\n        var ret = tempArray;\n        tempArray.length = 0;\n\n        var tick = _TICK++;\n        var index = 0;\n\n        for(y=sy;y<=ey;y++)\n        {\n            for(x=sx;x<=ex;x++)\n            {\n                var id = y * this.width + x;\n\n                var cell = this.hash[id];\n\n                if( cell )\n                {\n                    for (var i = 0; i < cell.length; i++)\n                    {\n\n                        var item = cell[i];\n\n                        if(item._TICK !== tick)\n                        {\n                            item._TICK = tick;\n                            ret[index++] = item;\n                        }\n\n                    };\n                }\n            }\n        }\n\n        return  ret;\n\n    }\n\n    SpatialHash.prototype.removeDuplicates = function(array)\n    {\n        var seen = {};\n        var out = [];\n        var len = array.length;\n        var j = 0;\n        for(var i = 0; i < len; i++) {\n             var item = array[i];\n             if(seen[item.UID] !== 1) {\n                   seen[item.UID] = 1;\n                   out[j++] = item;\n             }\n        }\n        return out;\n    }\n\n    SpatialHash.prototype.remove = function(obj)\n    {\n        var shift = 5; // power of two!\n\n        /* @mat it used to be this next line\n\n        var hitArea = obj.hitArea.hitArea;\n        not sure how that ever worked since obj.hitArea doesn't exist ? maybe a legacy thing :)\n\n        and I changed it to this :\n        var hitArea = obj.body.shape;\n        */\n       var hitArea = obj.body.shape;\n\n        var sx = ((obj.position.x + hitArea.x) / this.size) | 0,\n            sy = ((obj.position.y + hitArea.y) / this.size) | 0,\n            ex = ((obj.position.x +  hitArea.x + hitArea.width )/ this.size) | 0,\n            ey = ((obj.position.y +  hitArea.y + hitArea.height)/ this.size) | 0,\n            x, y;\n        for(y=sy;y<=ey;y++)\n        {\n            for(x=sx;x<=ex;x++)\n            {\n                var id = y * this.width + x;\n                if(id > 0)\n                {\n\n                    var index = this.hash[id].indexOf(obj);\n                    if(index !== -1)\n                    {\n                        this.hash[id].splice(index, 1);\n                    }\n\n                }\n\n                // also remove from cache..\n                // TODO OPTIMISE..\n                this.cache = {};\n            }\n        }\n\n        //TODO invalidate caches??\n    }\n\n    SpatialHash.prototype.empty = function()\n    {\n        this.buildHash();\n    }\n\n    module.exports = SpatialHash;\n\n});"]}