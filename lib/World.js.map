{"version":3,"sources":["../src/World.js"],"names":["World","onCollideBegin","onCollideEnd","staticBodies","STATIC","dynamicBodies","DYNAMIC","bodies","collisions","narrowPhase","dt","collisionKeys","DEBUG","registerCollison","add","body","type","remove","update","getCollisions","i","children","length","collide","reset","empty","getKey","a","b","type1","type2","updateBounds","list","size","sortAxisList","body1","newItemLeft","position","x","boundingBox","upper","j","body2","currentItemRight","lower","canCollide","push","key","collisionMask","l","v","a2"],"mappings":"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","file":"World.js","sourcesContent":["  //  var CollisionTest = require('../Group');\n\nimport Group from './utils/Group';\nimport Body from './Body';\n\nimport NarrowPhase from './NarrowPhase';\nimport Signal from 'mini-signals';\n\nexport default class World\n{\n\n\n    constructor()\n    {\n        // on hit test against.. platforms\n        this.onCollideBegin = new Signal();\n        this.onCollideEnd = new Signal();\n\n        this.staticBodies = this[Body.STATIC] = new Group();\n        this.dynamicBodies = this[Body.DYNAMIC] = new Group();\n        this.bodies = new Group();\n\n        this.collisions = [];\n        this.narrowPhase = new NarrowPhase(this);\n\n        this.dt = 1;\n\n        this.collisionKeys = {};\n\n        this.DEBUG = false;\n\n        this.registerCollison(0,0);\n\n\n\n\n    }\n\n    add(body)\n    {\n        this[body.type].add(body);\n        this.bodies.add(body);\n    }\n\n    remove(body)\n    {\n        this[body.type].remove(body);\n        this.bodies.remove(body);\n    }\n\n    update()\n    {\n\n        //TODO broadphase\n\n        var collisions = this.getCollisions();\n        //console.log(collisions);\n\n        for (var i = 0; i < this.dynamicBodies.children.length; i++)\n        {\n            this.dynamicBodies.children[i].update(this.dt);\n        };\n\n        this.narrowPhase.collide(collisions);\n       // };\n\n\n    }\n\n    reset()\n    {\n        this.staticBodies.empty();\n        this.dynamicBodies.empty();\n        this.bodies.empty();\n\n        this.collisions.length = 0;\n\n        this.narrowPhase.reset();\n\n    }\n\n    getKey(a, b)\n    {\n        return (a << 12) + b;\n    }\n\n    registerCollison(type1, type2)\n    {\n        this.collisionKeys[this.getKey(type1, type2)] = true;\n        this.collisionKeys[this.getKey(type2, type1)] = true;\n    }\n\n    updateBounds()\n    {\n        // TODO no need to update static!\n        var list = this.bodies.children;\n\n        for (var i = 0; i < list.length; i++)\n        {\n            list[i].updateBounds();\n        }\n    }\n\n    getCollisions()\n    {\n        this.collisions.length = 0;\n\n        var size = 0;\n\n        this.updateBounds();\n\n        //SAP!\n        var list =  this.bodies.children;\n\n        this.sortAxisList( list );\n\n        for (var i = 0; i < list.length; i++)\n        {\n            var body1 = list[i];\n            var newItemLeft = body1.position.x + body1.boundingBox.upper.x;\n            for (var j = i+1; j < list.length; j++)\n            {\n                var body2 = list[j];\n\n                var currentItemRight = body2.position.x + body2.boundingBox.lower.x;// - 5;\n\n                if(newItemLeft <= currentItemRight)\n                {\n                    break;\n                }\n                else\n                {\n\n                    if(this.canCollide(body1, body2))\n                    {\n                       this.collisions.push(body1,\n                                            body2);\n                    }\n\n                }\n            }\n        };\n\n        // finallly hit tes the bounds..\n\n        return this.collisions;\n    }\n\n    canCollide(body1, body2)\n    {\n        if((body1.type | body2.type) !== (Body.STATIC | Body.STATIC))\n        {\n            if(body2.canCollide && body1.canCollide)\n            {\n                var key = this.getKey(body2.collisionMask, body1.collisionMask)\n\n                if(this.collisionKeys[key])\n                {\n                    return true;\n                }\n            }\n        }\n\n\n        return false;\n    }\n\n    sortAxisList(a)\n    {\n        for(var i=1,l=a.length; i<l; i++)\n        {\n            var v = a[i];\n            for(var j=i - 1;j>=0;j--)\n            {\n                var a2 = a[j];\n\n                if(a2.boundingBox.lower.x + a2.position.x  <= v.boundingBox.lower.x + v.position.x )\n                {\n                    break;\n                }\n\n                a[j+1] = a[j];\n            }\n\n            a[j+1] = v;\n        }\n\n        return a;\n    };\n\n}"]}